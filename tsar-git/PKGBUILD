# Maintainer: Allen Zhong <moeallenz@gmail.com>
# Contributor: Felix Yan <felixonmars@gmail.com>

pkgname=tsar-git
_gitname=tsar
pkgver=0.121.3c54b6e
pkgrel=2
pkgdesc="Taobao System Activity Reporter"
arch=('i686' 'x86_64')
url="http://tsar.taobao.org/"
license=('Apache')
depends=('glibc')
makedepends=('git')
backup=('etc/tsar/tsar.conf'
	'var/log/tsar.data')
source=("git://github.com/alibaba/$_gitname.git"
	"fix_module_path.patch"
	"fix_apache_log.patch")
md5sums=('SKIP'
	 '2ddf971bbdaac82fdfbe1610a420a940'
         'a26d9075778ed636cb5b48092979bb3e')

pkgver() {
  cd "$srcdir/$_gitname"
  echo "0.$(git rev-list --count HEAD).$(git describe --always)"
}

build() {
  cd "$srcdir/${_gitname}"
  patch -Np1 -i "$srcdir"/fix_module_path.patch
  patch -Np1 -i "$srcdir"/fix_apache_log.patch
  make  # --prefix=/usr Not supported, WTF
}

package() {
  cd "$srcdir/${_gitname}"

  install -d "$pkgdir"/usr/lib/tsar/modules
  cp modules/*.so "$pkgdir"/usr/lib/tsar/modules/
  
  install -Dm755 src/tsar "$pkgdir"/usr/bin/tsar

  install -d "$pkgdir"/var/log
  touch "$pkgdir"/var/log/tsar.data

  install -Dm644 conf/tsar.conf "$pkgdir"/etc/tsar/tsar.conf
  install -Dm644 conf/tsar.logrotate "$pkgdir"/etc/logrotate.d/tsar
  install -Dm644 conf/tsar.cron "$pkgdir"/etc/cron.d/tsar

  install -Dm644 conf/tsar.8 "$pkgdir"/usr/share/man/man8/tsar.8
}
